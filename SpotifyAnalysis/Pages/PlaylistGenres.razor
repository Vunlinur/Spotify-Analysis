@page "/playlistgenres"

@using Fernandezja.ColorHashSharp
@using SpotifyAnalysis.Data
@using SpotifyAnalysis.Data.DTO
@using System.Threading
@using System.Collections.Concurrent
@using MudBlazor
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;

@inject IDialogService dialogService;
@inject ProtectedLocalStorage localStorage
@inject ScopedData data;


@if (loaded) {
	<MudDataGrid T="Playlist" @ref=dataGrid Items="@Playlists" FixedHeader Class="full-height-table" Groupable
				 SortMode="SortMode.Multiple" QuickFilter=@Filter >
		<ToolBarContent>
			<MudText Typo="Typo.h6">Top 3 playlist genres</MudText>
			<ExpandCollapseAllGroups DataGrid=@dataGrid />
			<MudSpacer />
			<MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
						  AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
		</ToolBarContent>
		<Columns>
			<TemplateColumn Sortable=false Groupable=false HeaderStyle="width: 50px">
				<CellTemplate>
					<MudImage Height="50" Width="50" Src=@GetImage(context) />
				</CellTemplate>
			</TemplateColumn>
			<PropertyColumn Property="x => x.playlistDTO.Name" Title="Name" Groupable=false />
			<PropertyColumn Property="x => x.playlistDTO.OwnerName" Title="Owner" CellStyle="color: grey" >
				<GroupTemplate>
					<GroupTemplateCounted Name="Owner" Context=@context />
				</GroupTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.playlistDTO.TracksTotal" Title="Tracks" Groupable=false HeaderStyle="width:60px" />
			<PropertyColumn Property="x => x.genre1.root" Title="#1">
				<CellTemplate>
					<GenreRatio Context="context" Genre="context.Item.genre1"/>
				</CellTemplate>
				<GroupTemplate>
					<GroupTemplateCounted Name="#1" Context=@context />
				</GroupTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.genre2.root" Title="#2">
				<CellTemplate>
					<GenreRatio Context="context" Genre="context.Item.genre2" />
				</CellTemplate>
				<GroupTemplate>
					<GroupTemplateCounted Name="#2" Context=@context />
				</GroupTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.genre3.root" Title="#3">
				<CellTemplate>
					<GenreRatio Context="context" Genre="context.Item.genre3" />
				</CellTemplate>
				<GroupTemplate>
					<GroupTemplateCounted Name="#3" Context=@context />
				</GroupTemplate>
			</PropertyColumn>
		</Columns>
	</MudDataGrid>
}

<style>
	tr > td:nth-child(n + 5) {
		padding: 0 4px;
	}

	td > div {
		width: 100%;
		font-weight: bold;
    }

	.mud-chip {
		padding: 0;
	}

	.mud-chip.mud-chip-size-medium {
		height: 42px;
	}
</style>

@code {
	IEnumerable<Playlist> Playlists { get; set; }
	bool loaded;
	string searchString;
	MudDataGrid<Playlist> dataGrid;

	protected override async Task OnInitializedAsync() {
		await base.OnInitializedAsync();
		var playlistsTasks = data.UserDTO.Playlists.Select(CalculateGenresAsync).ToArray();
		Playlists = await Task.WhenAll(playlistsTasks);
		Color(Playlists);
		loaded = true;
	}

	async Task<Playlist> CalculateGenresAsync(PlaylistDTO playlistDTO) => await Task.Run(() => 
			new Playlist(playlistDTO, CalculatePlaylistGenres(playlistDTO))
		);

	List<Genre> CalculatePlaylistGenres(PlaylistDTO p) {
		var topGenres = new ConcurrentDictionary<string, int>(StringComparer.OrdinalIgnoreCase);
		var tasks = p.Tracks.Select(async track => {
			foreach (var artist in track.Artists) 
				foreach (string genre in artist.Genres)
					topGenres.AddOrUpdate(genre, 1, (_, count) => count + 1);
		}).ToArray();

		Task.WaitAll(tasks);

		return topGenres
			.OrderByDescending(kv => kv.Value)
			.Take(3)
			.Select(kv => new Genre(kv.Key, kv.Value))
			.ToList();
	}

	void Color(IEnumerable<Playlist> playlists) {
		Dictionary<string, Genre> genreColors = new(StringComparer.OrdinalIgnoreCase);
		foreach (var playlist in playlists)
			playlist.topGenres.Color(genreColors);
	}

	bool Filter(Playlist p) {
		if (string.IsNullOrWhiteSpace(searchString))
			return true;

		if (p.playlistDTO.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
			return true;

		if (p.playlistDTO.OwnerName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
			return true;

		foreach (var genre in p.topGenres)
			if (genre.name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
				return true;

		return false;
	}

	string GetImage(CellContext<Playlist> c) => c.Item.playlistDTO.ImageS ?? StaticResourceMap.UnknownPlaylist;
}
