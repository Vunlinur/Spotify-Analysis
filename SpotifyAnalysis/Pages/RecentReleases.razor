@page "/recentreleases"

@using SpotifyAnalysis.Data.SpotifyAPI
@using Fernandezja.ColorHashSharp
@using SpotifyAnalysis.Data
@using SpotifyAnalysis.Data.DTO
@using SpotifyAnalysis.Data.Database
@using System.Threading
@using System.Collections.Concurrent
@using MudBlazor
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;
@using Microsoft.EntityFrameworkCore;

@inject SpotifyModuleFactory spotifyModuleFactory;
@inject IDialogService dialogService;
@inject ProtectedLocalStorage localStorage
@inject ScopedData data;


@if (loaded) {
	<MudDataGrid T="ArtistWithReleases" Items="@ArtistsWithReleases" FixedHeader Class="full-height-table"
				 SortMode="SortMode.Multiple" QuickFilter=@Filter >
		<ToolBarContent>
			<MudText Typo="Typo.h6">Recent Releases</MudText>
			<MudSpacer />
			<MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
						  AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
		</ToolBarContent>
		<Columns>
			<PropertyColumn Title="Artist" Property="x => x.Artist.Name" />
			<TemplateColumn Title="Recent Releases">
				<CellTemplate>
					<MudStack Row Spacing="2" Style="width: 100%;">
						@foreach (var release in context.Item.RecentReleases) {
							<MudCard Elevation="2" Style="width: 100%;">
								<MudCardContent>
									<MudText Typo="Typo.body1">@release.Name</MudText>
								</MudCardContent>
							</MudCard>
						}
					</MudStack>
				</CellTemplate>
			</TemplateColumn>
		</Columns>
	</MudDataGrid>
}


@code {
	bool loaded;
	string searchString;
	List<ArtistWithReleases> ArtistsWithReleases;

	protected override async Task OnInitializedAsync() {
		await base.OnInitializedAsync();

		var spotifyModule = spotifyModuleFactory.GetModule();
		var topArtists = await spotifyModule.GetUsersTopArtists();
		var topArtistIds = topArtists.Select(a => a.Id).ToList();

		var cutoffDate = DateTime.UtcNow.AddDays(-365);
		ArtistsWithReleases = new List<ArtistWithReleases>();

		using var db = new SpotifyContext();

		// Get artists from the database that belong to top artists
		var topArtistsDTOs = await db.Artists
			.Include(a => a.Albums)
			.Where(a => topArtistIds.Contains(a.ID))
			.OrderBy(a => a.Name)
			.ToListAsync();

		foreach (var artist in topArtistsDTOs) {
			var artistAlbums = artist.Albums
				.Where(album => IsWithinLastYear(album.ReleaseDate, cutoffDate))
				.OrderByDescending(album => AlbumDTO.ParseReleaseDate(album.ReleaseDate))
				.ToList();

			if (artistAlbums.Count > 0)
				ArtistsWithReleases.Add(new ArtistWithReleases {
					Artist = artist,
					RecentReleases = artistAlbums
				});
		}

		loaded = true;
	}

	bool Filter(ArtistWithReleases p) {
		if (string.IsNullOrWhiteSpace(searchString))
			return true;

		if (p.Artist.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
			return true;

		if (p.RecentReleases.Any(r => r.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase)))
			return true;

		return false;
	}

	private static bool IsWithinLastYear(string releaseDate, DateTime cutoffDate) {
		if (string.IsNullOrEmpty(releaseDate))
			return false;

		var parsedDate = AlbumDTO.ParseReleaseDate(releaseDate);
		return parsedDate >= cutoffDate;
	}

	private class ArtistWithReleases {
		public ArtistDTO Artist { get; set; }
		public List<AlbumDTO> RecentReleases { get; set; } = [];
	}
}

