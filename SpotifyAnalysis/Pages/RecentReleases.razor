@page "/recentreleases"

@using SpotifyAnalysis.Data.SpotifyAPI
@using Fernandezja.ColorHashSharp
@using SpotifyAnalysis.Data
@using SpotifyAnalysis.Data.DTO
@using SpotifyAnalysis.Data.Database
@using System.Threading
@using System.Collections.Concurrent
@using MudBlazor
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;
@using Microsoft.EntityFrameworkCore;

@inject SpotifyModuleFactory spotifyModuleFactory;
@inject IDialogService dialogService;
@inject ProtectedLocalStorage localStorage
@inject ScopedData data;


<MudAppBar Color="Color.Surface" Fixed="false" Style="width: -webkit-fill-available; width: -moz-available;">
	<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center Style="width: 100%">
		<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center>
			<MudText Align=Align.Right>All Artists From User's Playlists</MudText>
			<MudSwitch T=bool ValueChanged=OnAllArtistsSwitchChanged Color="Color.Tertiary" UncheckedColor="Color.Primary" Size=Size.Large />
			<MudText>Your Top Artists</MudText>
		</MudStack>
		<MudText Typo=Typo.subtitle1>Legend:</MudText>
		<MudPaper Class="pa-2">
			<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center Style="width: 300px">
				<MudText Typo="Typo.body1"><b>Artist Name</b></MudText>
				<MudText Typo="Typo.subtitle2">Release Date</MudText>
			</MudStack>
		</MudPaper>
		<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center>
			@foreach(var type in Enum.GetValues<AlbumType>()) {
				<MudPaper Class="pa-2" Style=@CardStyle(type)>
                    <MudText Typo="Typo.button">@type.ToString().Replace("_"," ")</MudText>
                </MudPaper>
			}
		</MudStack>
	</MudStack>
</MudAppBar>
@if (loaded) {
	<MudDataGrid T="ArtistWithReleases" Items="@ArtistsWithReleases" FixedHeader
				 SortMode="SortMode.Multiple" QuickFilter=@Filter >
		<ToolBarContent>
			<MudText Typo="Typo.h6">Recent Releases</MudText>
			<MudSpacer />
			<MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
						  AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
		</ToolBarContent>
		<Columns>
			<PropertyColumn Title="Artist" Property="x => x.Artist.Name" />

			<PropertyColumn Title="Popularity" Property="x => x.Artist.Popularity" Groupable=false HeaderStyle="width: 8%">
				<CellTemplate>
					<MudProgressLinear Color="Color.Primary" Value=@(context.Item.Artist.Popularity ?? 0) />
				</CellTemplate>
			</PropertyColumn>

			<TemplateColumn Title="Recent Releases">
				<CellTemplate>
					<MudStack Row Spacing="2" Style="width: 100%;">
						@foreach (var release in context.Item.RecentReleases) {
							<MudPaper Class="pa-2" Style=@CardStyle(release.Type)>
								<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center>
									<MudLink Typo="Typo.body1" Color=@Color.Default Href=@("spotify:album:" + release.ID)><b>@release.Name</b></MudLink>
									<MudDivider Vertical="true" FlexItem="true" />
									<MudText Typo="Typo.subtitle2">@release.ReleaseDate</MudText>
								</MudStack>
							</MudPaper>
						}
					</MudStack>
				</CellTemplate>
			</TemplateColumn>
		</Columns>
	</MudDataGrid>
}
<style>
	td > div > div {
		white-space: nowrap;
	}

	.mud-switch {
		margin: 0;
		padding: 0;
	}

	.mud-table .mud-table-container {
		max-height: calc(100vh - (var(--mud-appbar-height) * 11 / 4));
	}
</style>


@code {
	bool loaded;
	string searchString;
	List<string> topArtistIds;
	List<ArtistWithReleases> ArtistsWithReleases;

	protected override async Task OnInitializedAsync() {
		await base.OnInitializedAsync();

		// Initial calculation based on all artists in the 'inspecting' user's playlists
		var artistDTOs = await GetAllPlaylistsArtistsAsync();
		CalculateReleases(artistDTOs);
		loaded = true;
	}

	async Task<List<ArtistDTO>> GetTopArtistsAsync() {
		if (topArtistIds is null || topArtistIds.Count == 0) {
		var spotifyModule = spotifyModuleFactory.GetModule();
		var topArtists = await spotifyModule.GetUsersTopArtists();
		topArtistIds = topArtists.Select(a => a.Id).ToList();
	}

		using var db = new SpotifyContext();
		return await db.Artists
			.Include(a => a.Albums)
			.Where(a => topArtistIds.Contains(a.ID))
			.ToListAsync();
	}

	async Task<List<ArtistDTO>> GetAllPlaylistsArtistsAsync() {
		using var db = new SpotifyContext();
		return await db.Users
			.Where(u => u.ID == data.UserDTO.ID)
			.SelectMany(u => u.Playlists)
			.SelectMany(p => p.Tracks)
			.SelectMany(t => t.Artists)
			.Distinct()
			.Include(a => a.Albums)
			.ToListAsync();
	}

	void CalculateReleases(IEnumerable<ArtistDTO> artistsDTOs) {
		var cutoffDate = DateTime.UtcNow.AddDays(-365);
		ArtistsWithReleases = new List<ArtistWithReleases>();
		foreach (var artist in artistsDTOs) {
			var artistAlbums = artist.Albums
				.Where(album => IsWithinLastYear(album.ReleaseDate, cutoffDate))
				.OrderBy(album => AlbumDTO.ParseReleaseDate(album.ReleaseDate))
				.ToList();

			if (artistAlbums.Count > 0)
				ArtistsWithReleases.Add(new ArtistWithReleases {
						Artist = artist,
						RecentReleases = artistAlbums
					});
		}
	}

	async void OnAllArtistsSwitchChanged(bool value) {
		var artists = await (value ? GetTopArtistsAsync() : GetAllPlaylistsArtistsAsync());
		CalculateReleases(artists);
		StateHasChanged();
    }

	bool Filter(ArtistWithReleases p) {
		if (string.IsNullOrWhiteSpace(searchString))
			return true;

		if (p.Artist.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
			return true;

		if (p.RecentReleases.Any(r => r.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase)))
			return true;

		return false;
	}

	private static bool IsWithinLastYear(string releaseDate, DateTime cutoffDate) {
		if (string.IsNullOrEmpty(releaseDate))
			return false;

		var parsedDate = AlbumDTO.ParseReleaseDate(releaseDate);
		return parsedDate >= cutoffDate;
	}

	private string CardStyle(AlbumType type)
		=> $"background: {type.ToColor()}";

	private class ArtistWithReleases {
		public ArtistDTO Artist { get; set; }
		public List<AlbumDTO> RecentReleases { get; set; } = [];
	}
}

