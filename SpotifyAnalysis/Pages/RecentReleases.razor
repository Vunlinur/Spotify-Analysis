@page "/recentreleases"

@using SpotifyAnalysis.Data.SpotifyAPI
@using Fernandezja.ColorHashSharp
@using SpotifyAnalysis.Data
@using SpotifyAnalysis.Data.DTO
@using SpotifyAnalysis.Data.Database
@using System.Threading
@using System.Collections.Concurrent
@using MudBlazor
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;
@using Microsoft.EntityFrameworkCore;

@inject SpotifyModuleFactory spotifyModuleFactory;
@inject IDialogService dialogService;
@inject ProtectedLocalStorage localStorage
@inject ScopedData data;


<MudAppBar Color="Color.Surface" Fixed="false" Style="width: -webkit-fill-available; width: -moz-available;">
	<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center Style="width: 100%">
		<MudText Typo=Typo.subtitle1>Legend:</MudText>
		<MudPaper Class="pa-2">
			<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center Style="width: 300px">
				<MudText Typo="Typo.body1"><b>Artist Name</b></MudText>
				<MudText Typo="Typo.subtitle2">Release Date</MudText>
			</MudStack>
		</MudPaper>
		<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center>
			@foreach(var type in Enum.GetValues<AlbumType>()) {
				<MudPaper Class="pa-2" Style=@CardStyle(type)>
                    <MudText Typo="Typo.button">@type.ToString().Replace("_"," ")</MudText>
                </MudPaper>
			}
		</MudStack>
	</MudStack>
</MudAppBar>
@if (loaded) {
	<MudDataGrid T="ArtistWithReleases" Items="@ArtistsWithReleases" FixedHeader Class="full-height-table"
				 SortMode="SortMode.Multiple" QuickFilter=@Filter >
		<ToolBarContent>
			<MudText Typo="Typo.h6">Recent Releases</MudText>
			<MudSpacer />
			<MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
						  AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
		</ToolBarContent>
		<Columns>
			<PropertyColumn Title="Artist" Property="x => x.Artist.Name" />
			<TemplateColumn Title="Recent Releases">
				<CellTemplate>
					<MudStack Row Spacing="2" Style="width: 100%;">
						@foreach (var release in context.Item.RecentReleases) {
							<MudPaper Class="pa-2" Style=@CardStyle(release.Type)>
								<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center>
									<MudLink Typo="Typo.body1" Color=@Color.Default Href=@("spotify:album:" + release.ID)><b>@release.Name</b></MudLink>
									<MudText Typo="Typo.subtitle2">@release.ReleaseDate</MudText>
								</MudStack>
							</MudPaper>
						}
					</MudStack>
				</CellTemplate>
			</TemplateColumn>
		</Columns>
	</MudDataGrid>
}
	td > div > div {


@code {
	bool loaded;
	string searchString;
	List<ArtistWithReleases> ArtistsWithReleases;

	protected override async Task OnInitializedAsync() {
		await base.OnInitializedAsync();

		var spotifyModule = spotifyModuleFactory.GetModule();
		var topArtists = await spotifyModule.GetUsersTopArtists();
		var topArtistIds = topArtists.Select(a => a.Id).ToList();

		var cutoffDate = DateTime.UtcNow.AddDays(-365);
		ArtistsWithReleases = new List<ArtistWithReleases>();

		using var db = new SpotifyContext();

		// Get artists from the database that belong to top artists
		var topArtistsDTOs = await db.Artists
			.Include(a => a.Albums)
			.Where(a => topArtistIds.Contains(a.ID))
			.OrderBy(a => a.Name)
			.ToListAsync();

		foreach (var artist in topArtistsDTOs) {
			var artistAlbums = artist.Albums
				.Where(album => IsWithinLastYear(album.ReleaseDate, cutoffDate))
				.OrderByDescending(album => AlbumDTO.ParseReleaseDate(album.ReleaseDate))
				.ToList();

			if (artistAlbums.Count > 0)
				ArtistsWithReleases.Add(new ArtistWithReleases {
					Artist = artist,
					RecentReleases = artistAlbums
				});
		}

		loaded = true;
	}

	bool Filter(ArtistWithReleases p) {
		if (string.IsNullOrWhiteSpace(searchString))
			return true;

		if (p.Artist.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
			return true;

		if (p.RecentReleases.Any(r => r.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase)))
			return true;

		return false;
	}

	private static bool IsWithinLastYear(string releaseDate, DateTime cutoffDate) {
		if (string.IsNullOrEmpty(releaseDate))
			return false;

		var parsedDate = AlbumDTO.ParseReleaseDate(releaseDate);
		return parsedDate >= cutoffDate;
	}

	private string CardStyle(AlbumType type)
		=> $"background: {type.ToColor()}";

	private class ArtistWithReleases {
		public ArtistDTO Artist { get; set; }
		public List<AlbumDTO> RecentReleases { get; set; } = [];
	}
}

