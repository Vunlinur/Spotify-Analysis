@page "/recentreleases"

@using SpotifyAnalysis.Data.SpotifyAPI
@using SpotifyAnalysis.Data
@using SpotifyAnalysis.Data.DTO
@using SpotifyAnalysis.Data.Database
@using System.Threading
@using Microsoft.EntityFrameworkCore;
@using MudBlazor
@using ApexCharts;
@using System.Text.Json;

@inject SpotifyModuleFactory spotifyModuleFactory;
@inject IDialogService dialogService;
@inject ScopedData data;


<MudAppBar Color="MudBlazor.Color.Surface" Fixed="false" Style="width: -webkit-fill-available; width: -moz-available;">
	<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center Style="width: 100%">
		<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center>
			<MudText Align=MudBlazor.Align.Right>All Artists From User's Playlists</MudText>
			<MudSwitch T=bool ValueChanged=OnAllArtistsSwitchChanged Color="MudBlazor.Color.Tertiary" UncheckedColor="MudBlazor.Color.Primary" Size=MudBlazor.Size.Large />
			<MudText>Your Top Artists</MudText>
		</MudStack>
		<MudText Typo=Typo.subtitle1>Legend:</MudText>
		<MudPaper Class="pa-2">
			<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center Style="width: 260px">
				<MudText Typo="Typo.body1"><b>Artist Name</b></MudText>
				<MudDivider Vertical="true" FlexItem="true" />
				<MudText Typo="Typo.subtitle2">Release Date</MudText>
			</MudStack>
		</MudPaper>
		<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center>
			@foreach(var type in Enum.GetValues<AlbumType>()) {
				<MudPaper Class="pa-2" Style=@CardStyle(type)>
					<MudText Typo="Typo.button" Style="white-space: nowrap">@type.ToString().Replace("_", " ")</MudText>
                </MudPaper>
			}
		</MudStack>
	</MudStack>
</MudAppBar>
@if (loaded) {
	<ApexChart TItem="AlbumDTO" Title="Artists' Latest Releases"
	            XAxisType="XAxisType.Datetime"
	            Options="chartOptions">

		@foreach (var (artist, index) in artistsWithReleases.Select((awr, i) => (awr, i))) {
			<ApexBubbleSeries TItem="AlbumDTO"
			@key="artist.Artist?.Name"
			Items=@artist.RecentReleases
	        Name=@(artist.Artist?.Name ?? "Unknown")
	        XValue=@(e => e.ReleaseDate)
			YAggregate=@(e => index)
			ZAggregate=@(e => e.Select(a => a.Popularity).Sum())
			PointColor=@(e => e.Type.ToColor())
			/>
		}
	</ApexChart>





	<MudDataGrid T="ArtistWithReleases" Items="@artistsWithReleases" FixedHeader
				 SortMode="SortMode.Multiple" QuickFilter=@Filter >
		<ToolBarContent>
			<MudText Typo="Typo.h6">Recent Releases</MudText>
			<MudSpacer />
			<MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
						  AdornmentIcon="@Icons.Material.Filled.Search" IconSize="MudBlazor.Size.Medium" Class="mt-0"></MudTextField>
		</ToolBarContent>
		<Columns>
			<PropertyColumn Title="Artist" Property="x => x.Artist.Name" />

			<PropertyColumn Title="Popularity" Property="x => x.Artist.Popularity" Groupable=false HeaderStyle="width: 8%">
				<CellTemplate>
					<MudProgressLinear Color="MudBlazor.Color.Primary" Value=@(context.Item.Artist.Popularity ?? 0) />
				</CellTemplate>
			</PropertyColumn>

			<TemplateColumn Title="Recent Releases">
				<CellTemplate>
					<MudStack Row Spacing="2" Style="width: 100%;">
						@foreach (var release in context.Item.RecentReleases) {
							<MudPaper Class="pa-2" Style=@CardStyle(release.Type)>
								<MudStack Row Justify=Justify.SpaceBetween AlignItems=AlignItems.Center>
									<MudLink Typo="Typo.body1" Color=@MudBlazor.Color.Default Href=@("spotify:album:" + release.ID)><b>@release.Name</b></MudLink>
									<MudDivider Vertical="true" FlexItem="true" />
									<MudText Typo="Typo.subtitle2">@release.ReleaseDate</MudText>
								</MudStack>
							</MudPaper>
						}
					</MudStack>
				</CellTemplate>
			</TemplateColumn>
		</Columns>
	</MudDataGrid>
}
<style>
	.mud-switch {
		margin: 0;
		padding: 0;
	}

	.mud-table .mud-table-container {
		max-height: calc(100vh - (var(--mud-appbar-height) * 11 / 4));
	}

	/* Alternating Y-axis grid line colors hack as ApexCharts has no per-line coloring */
	.apexcharts-canvas *> .apexcharts-grid .apexcharts-gridlines-horizontal line:nth-child(odd) {
		stroke: #cccccc;
	}
</style>


@code {
	bool loaded;
	string searchString;
	List<string> topArtistIds;
	List<ArtistWithReleases> artistsWithReleases;
	ApexChartOptions<AlbumDTO> chartOptions => BuildChartOptions(artistsWithReleases);

	private ApexChartOptions<AlbumDTO> BuildChartOptions(List<ArtistWithReleases> artistsWithReleases) {
		string[] alternatingLabelColors = ["#1aa14b", "#cccccc"];
		var count = artistsWithReleases?.Count ?? 0;

		var artistNames = artistsWithReleases.Select(a => a.Artist?.Name ?? "Unknown").ToList();
		var namesJson = JsonSerializer.Serialize(artistNames);
		var yAxisFormatter = $"function(val) {{ var n = {namesJson}; return n[val] !== undefined ? n[val] : ''; }}";

		var opts = new ApexChartOptions<AlbumDTO> {
			Debug = true,
			Chart = new Chart { Height = "80%" },
			Grid = new Grid {
					BorderColor = "#1aa14b",
				//Row = new GridRow {
				//	Colors = AlternatingLabelColors.ToList(),
				//	Opacity = 0.2
				//}
			},
			PlotOptions = new PlotOptions {
				Bubble = new PlotOptionsBubble { MinBubbleRadius = 4, MaxBubbleRadius = 16 }
			},
			Tooltip = new ApexCharts.Tooltip {
				X = new TooltipX { Format = @"MMMM \ yyyy", Show = true },
				Y = new TooltipY {
					Title = new TooltipYTitle { Formatter = @"function(name) { return name + ':' }" },
					Formatter = @"function(value, { series, seriesIndex, dataPointIndex, w }) { return '$' + value }"
				}
			},
			Xaxis = new XAxis {
				Title = new AxisTitle {
					OffsetY = 5,
					Text = "Month",
					Style = new AxisTitleStyle { FontSize = "14px", Color = "#aaaaaa" }
				},
				Labels = new XAxisLabels { Style = new AxisLabelStyle { FontSize = "10px", Colors = "#aaaaaa" } },
				AxisBorder = new AxisBorder { Height = 0 }
			},
			Legend = new Legend { Show = false },
			Annotations = new Annotations { Yaxis = new List<AnnotationsYAxis>() },
			Yaxis = new List<YAxis>() {
				new YAxis {
					Min = -1,
					Max = count,
					TickAmount = count + 1,
					ForceNiceScale = false,
					Title = new AxisTitle { Text = "Artist", Style = new AxisTitleStyle { FontSize = "14px", Color = "#aaaaaa" } },
					Labels = new YAxisLabels {
						Style = new AxisLabelStyle {
							FontSize = "12px",
							Colors = new ApexCharts.Color(alternatingLabelColors)
						},
						Formatter = yAxisFormatter
					}
				}
			}
		};

		return opts;
	}

	protected override async Task OnInitializedAsync() {
		await base.OnInitializedAsync();
		var artistDTOs = await GetAllPlaylistsArtistsAsync();
		artistsWithReleases = CalculateReleases(artistDTOs);
		loaded = true;
	}

	async Task<List<ArtistDTO>> GetTopArtistsAsync() {
		if (topArtistIds is null || topArtistIds.Count == 0) {
			var spotifyModule = spotifyModuleFactory.GetModule();
			var topArtists = await spotifyModule.GetUsersTopArtists();
			topArtistIds = topArtists.Select(a => a.Id).ToList();
		}

		using var db = new SpotifyContext();
		return await db.Artists
			.Include(a => a.Albums)
			.Where(a => topArtistIds.Contains(a.ID))
			.ToListAsync();
	}

	async Task<List<ArtistDTO>> GetAllPlaylistsArtistsAsync() {
		using var db = new SpotifyContext();
		return await db.Users
			.Where(u => u.ID == data.UserDTO.ID)
			.SelectMany(u => u.Playlists)
			.SelectMany(p => p.Tracks)
			.SelectMany(t => t.Artists)
			.Distinct()
			.Include(a => a.Albums)
			.ToListAsync();
	}

	static List<ArtistWithReleases> CalculateReleases(IEnumerable<ArtistDTO> artistsDTOs) {
		var cutoffDate = DateTime.UtcNow.AddDays(-365);
		var artistsWithReleases = new List<ArtistWithReleases>();
		foreach (var artist in artistsDTOs) {
			var artistAlbums = artist.Albums
				.Where(album => IsWithinLastYear(album.ReleaseDate, cutoffDate))
				.OrderBy(album => AlbumDTO.ParseReleaseDate(album.ReleaseDate))
				.ToList();

			if (artistAlbums.Count > 0)
				artistsWithReleases.Add(new ArtistWithReleases {
						Artist = artist,
						RecentReleases = artistAlbums
					});
		}
		return artistsWithReleases;
	}

	async void OnAllArtistsSwitchChanged(bool value) {
		var artists = await (value ? GetTopArtistsAsync() : GetAllPlaylistsArtistsAsync());
		artistsWithReleases = CalculateReleases(artists);
		StateHasChanged();
	}

	bool Filter(ArtistWithReleases p) {
		if (string.IsNullOrWhiteSpace(searchString))
			return true;

		if (p.Artist.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
			return true;

		if (p.RecentReleases.Any(r => r.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase)))
			return true;

		return false;
	}

	private static bool IsWithinLastYear(string releaseDate, DateTime cutoffDate) {
		if (string.IsNullOrEmpty(releaseDate))
			return false;

		var parsedDate = AlbumDTO.ParseReleaseDate(releaseDate);
		return parsedDate >= cutoffDate;
	}

	private string CardStyle(AlbumType type)
		=> $"background: {type.ToColor()}";

	private class ArtistWithReleases {
		public ArtistDTO Artist { get; set; }
		public List<AlbumDTO> RecentReleases { get; set; } = [];
	}
}

